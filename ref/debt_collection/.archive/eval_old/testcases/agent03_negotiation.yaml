agent_id: debt_collection
sub_agent_id: negotiation
description: "Tests for negotiation agent - payment arrangements"

# Test Data Configuration
default_test_data:
  full_name: "John Smith"
  user_id: "U12345"
  username: "jsmith001"
  id_number: "8501015800087"
  outstanding_amount: 2500.00
  overdue_days: 45
  script_type: "ratio1_inflow"
  account_status: "active"

test_cases:
  - name: "NEG-001: Accept settlement offer"
    test_type: single_turn
    tags: [unit, negotiation, settlement]
    turns:
      - user_input: "Yes, I can pay the settlement amount today"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

  - name: "NEG-002: Request installment plan"
    test_type: single_turn
    tags: [unit, negotiation, installment]
    turns:
      - user_input: "I can't pay it all at once, can I pay monthly?"
        assertions:
          - type: llm-rubric
            value: "Agent should offer or discuss installment options"

  - name: "NEG-003: Cancellation request"
    test_type: single_turn
    tags: [unit, negotiation, cancellation]
    turns:
      - user_input: "I want to cancel my Cartrack subscription"
        assertions:
          - type: contains_function_call
            value: "handle_cancellation_request"

  - name: "NEG-004: Escalation to supervisor"
    test_type: single_turn
    tags: [unit, negotiation, escalation]
    turns:
      - user_input: "I want to speak to your manager"
        assertions:
          - type: contains_function_call
            value: "escalate"

  - name: "NEG-005: Settlement offer inquiry"
    test_type: single_turn
    tags: [unit, negotiation, settlement]
    turns:
      - user_input: "What kind of settlement can you offer me?"
        assertions:
          - type: contains_function_call
            value: "offer_settlement"

  - name: "NEG-006: Payment refusal"
    test_type: single_turn
    tags: [unit, negotiation]
    turns:
      - user_input: "I'm not paying anything, this debt is not mine"
        assertions:
          - type: llm-rubric
            value: "Agent should explain consequences or attempt to verify the debt"

  - name: "NEG-007: Request callback during negotiation"
    test_type: single_turn
    tags: [unit, negotiation]
    turns:
      - user_input: "I need to check my finances first, call me back tomorrow"
        assertions:
          - type: contains_function_call
            value: "schedule_callback"

  - name: "NEG-008: Accept installment arrangement"
    test_type: multi_turn
    tags: [integration, negotiation, installment]
    turns:
      - user_input: "Can I pay in installments?"
        assertions:
          - type: contains_function_call
            value: "offer_installment"
      - user_input: "Yes, that works for me"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

  # ========================================================================
  # Script Type Scenarios
  # ========================================================================

  - name: "NEG-009: Short paid acknowledgment flow"
    test_type: multi_turn
    tags: [unit, negotiation, short_paid]
    test_data:
      script_type: "short_paid"
      partial_payment_received: 1000.00
      agreed_amount: 1500.00
      outstanding_amount: 500.00
    turns:
      - user_input: "I thought I already paid"
        assertions:
          - type: llm-rubric
            value: "Agent should acknowledge the R1000 payment received and explain R500 shortfall"
      - user_input: "Okay, I'll pay the shortfall"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

  - name: "NEG-010: Pro rata new customer flow"
    test_type: multi_turn
    tags: [unit, negotiation, pro_rata]
    test_data:
      script_type: "pro_rata_new"
      outstanding_amount: 350.00
      account_status: "active"
    turns:
      - user_input: "What is this payment for?"
        assertions:
          - type: llm-rubric
            value: "Agent should explain pro-rata payment covers partial month from installation date and services activate after payment"
      - user_input: "When will the debit happen?"
        assertions:
          - type: llm-rubric
            value: "Agent should mention agreed date and emphasize need for sufficient funds"

  - name: "NEG-011: Recently suspended - Tier 1 offer (50%)"
    test_type: multi_turn
    tags: [unit, negotiation, recently_suspended, tier1]
    test_data:
      script_type: "recently_suspended_120"
      outstanding_amount: 3000.00
      account_status: "active"
    turns:
      - user_input: "What discount can you offer?"
        assertions:
          - type: contains_function_call
            value: "offer_settlement"
          - type: llm-rubric
            value: "Agent should offer 50% discount (R1500) for once-off settlement"
      - user_input: "Yes, I'll pay the R1500"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

  - name: "NEG-012: Recently suspended - Tier 2 offer (40%) after Tier 1 rejection"
    test_type: multi_turn
    tags: [unit, negotiation, recently_suspended, tier2]
    test_data:
      script_type: "recently_suspended_120"
      outstanding_amount: 3000.00
      account_status: "active"
    turns:
      - user_input: "What discounts do you have?"
        assertions:
          - type: contains_function_call
            value: "offer_settlement"
          - type: llm-rubric
            value: "Agent should offer 50% discount (R1500) for once-off settlement"
      - user_input: "I can't afford R1500 all at once"
        assertions:
          - type: llm-rubric
            value: "Agent should offer 40% discount (R1800) in 2 installments"
          - type: contains_function_call
            value: "offer_installment"
      - user_input: "Yes, I'll take the installment plan"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

  - name: "NEG-013: Active account - benefits messaging"
    test_type: single_turn
    tags: [unit, negotiation, active_account]
    test_data:
      account_status: "active"
    turns:
      - user_input: "What happens if I pay?"
        assertions:
          - type: llm-rubric
            value: "Agent should mention services will be reinstated immediately and legal action will stop"

  - name: "NEG-014: Cancelled account - benefits messaging"
    test_type: single_turn
    tags: [unit, negotiation, cancelled_account]
    test_data:
      account_status: "cancelled"
    turns:
      - user_input: "What happens if I pay?"
        assertions:
          - type: llm-rubric
            value: "Agent should mention account will close in good standing and paid-up letter will be provided"
