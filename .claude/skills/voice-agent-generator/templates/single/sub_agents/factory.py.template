"""
Agent Factory for {agent_name}.

Creates and configures the main agent with instructions and tools.
Simplified factory for single-agent workflow.
"""

from pathlib import Path
import yaml

from .agent_main import MainAgent
from shared_state import UserData
from tools import get_tools_by_names
from prompts import load_instruction, format_instruction

# Load config
_config_path = Path(__file__).parent.parent / "agent.yaml"
CONFIG = yaml.safe_load(_config_path.read_text()) if _config_path.exists() else {}
VERSIONS = CONFIG.get("versions", {})
ACTIVE_VERSION = CONFIG.get("active_version")


def build_prompt_variables(userdata: UserData) -> dict:
    """Build template variables for the agent prompt.

    Args:
        userdata: The UserData instance for the session

    Returns:
        Dictionary of template variables for Mustache formatting
    """
    variables = CONFIG.get("variables", {})
    base_vars = {
        "agent_name": variables.get("default_agent_name", "Agent"),
    }

    # Add userdata-based variables
    if hasattr(userdata, 'to_prompt_vars'):
        base_vars.update(userdata.to_prompt_vars())

    # Add profile fields
    profile = userdata.profile
    base_vars.update({
        "user_name": profile.name,
        "user_id": profile.user_id,
    })

    return base_vars


def get_agent_instructions(userdata: UserData) -> str:
    """Load and format agent instructions.

    Uses active_version from agent.yaml if set.

    Args:
        userdata: The UserData instance for the session

    Returns:
        Formatted instruction string ready for the agent
    """
    source = CONFIG.get("instructions", "prompts/prompt_main.yaml")

    # Determine prompt_version from active_version config
    prompt_version = None
    if ACTIVE_VERSION and ACTIVE_VERSION in VERSIONS:
        version_config = VERSIONS[ACTIVE_VERSION]
        prompt_version = version_config.get("prompt_version")

    template = load_instruction(source, version=prompt_version)
    variables = build_prompt_variables(userdata)

    return format_instruction(template, **variables)


def create_agent(userdata: UserData) -> MainAgent:
    """Create the main agent with configured instructions and tools.

    Args:
        userdata: The UserData instance for the session

    Returns:
        MainAgent instance ready for the session
    """
    tools = CONFIG.get("tools", ["end_call", "schedule_callback"])

    return MainAgent(
        instructions=get_agent_instructions(userdata),
        tools=get_tools_by_names(tools, strict=False),
    )
