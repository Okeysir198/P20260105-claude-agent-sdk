services:
  # Trung-bot - API Server Mode
  trung-bot:
    build:
      context: .
      dockerfile: Dockerfile
    image: trung-bot:latest
    container_name: trung-bot-api

    # Host networking â€” container shares host's network stack
    # No ports mapping needed; API available at localhost:7003
    network_mode: host

    # Environment variables from production .env file
    env_file:
      - .env.docker

    environment:
      - PYTHONUNBUFFERED=1

    # Volumes for persistence
    volumes:
      # Session data persistence
      - ./data:/app/data

      # Claude configuration
      - trung-bot-config:/app/.claude

      # Host plugin cache (read-only, for official Anthropic plugins)
      - ${HOME}/.claude/plugins:/home/appuser/.claude/plugins:ro

      # Config file (allows provider switching without rebuild)
      - ./config.yaml:/app/config.yaml

    # Resource limits (per official Anthropic requirements: 1GiB RAM, 1 CPU)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Restart policy
    restart: unless-stopped

    # Command override for API server mode
    command: ["python", "main.py", "serve", "--port", "7003"]

  # Trung-bot CLI - Interactive Mode (optional)
  # Usage: docker compose run --rm trung-bot-cli
  trung-bot-cli:
    build:
      context: .
      dockerfile: Dockerfile
    image: trung-bot:latest

    # Interactive terminal
    stdin_open: true
    tty: true

    # Host networking
    network_mode: host

    # Environment
    env_file:
      - .env.docker
    environment:
      - PYTHONUNBUFFERED=1

    # Volumes
    volumes:
      - ./data:/app/data
      - trung-bot-config:/app/.claude
      - ${HOME}/.claude/plugins:/home/appuser/.claude/plugins:ro
      - ./config.yaml:/app/config.yaml

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # No restart policy for interactive mode
    restart: "no"

    # Default command (interactive chat)
    command: ["python", "main.py"]

    # Override with: docker compose run --rm trung-bot-cli <command>
    # Examples:
    #   docker compose run --rm trung-bot-cli skills
    #   docker compose run --rm trung-bot-cli agents
    #   docker compose run --rm trung-bot-cli sessions

volumes:
  trung-bot-config:
    driver: local
