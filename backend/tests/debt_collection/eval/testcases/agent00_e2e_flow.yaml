agent_id: debt_collection
sub_agent_id: e2e_flow
description: "End-to-end flow tests - Complete conversation scenarios across multiple agents"

# Test Data Configuration
default_test_data:
  full_name: "John Smith"
  user_id: "U12345"
  username: "jsmith001"
  id_number: "8501125678901"
  birth_date: "1985-01-12"
  email: "john.smith@example.com"
  contact_number: "0821234567"
  residential_address: "123 Main Street, Johannesburg, 2000"
  outstanding_amount: 2500.00
  overdue_days: 45
  script_type: "ratio1_inflow"
  account_status: "active"
  bank_name: "Standard Bank"
  bank_account_number: "123456789"
  branch_code: "051001"

test_cases:
  # ========================================================================
  # Happy Path - Full Successful Payment Flow
  # ========================================================================
  - name: "E2E-001: Complete flow - Settlement payment with immediate debit"
    test_type: multi_turn
    tags: [e2e, happy-path, settlement, immediate-debit]
    turns:
      # Introduction Phase
      - user_input: "Yes, this is John speaking"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
          - type: llm-rubric
            value: "Agent should proceed to verification without discussing account details"

      # Verification Phase
      - user_input: "My ID number is 8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "My date of birth is 12 January 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"

      # Negotiation Phase
      - user_input: "I can pay the settlement amount today"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"
          - type: llm-rubric
            value: "Agent should confirm settlement amount and transfer to payment"

      # Payment Phase
      - user_input: "Please debit my Standard Bank account immediately"
        assertions:
          - type: contains_function_call
            value: "capture_immediate_debit"
          - type: llm-rubric
            value: "Agent should mention R10 DebiCheck fee and SMS authentication"

      # Closing Phase
      - user_input: "Thank you, that's all"
        assertions:
          - type: contains_function_call
            value: "end_call"

  - name: "E2E-002: Complete flow - Installment plan with future debit"
    test_type: multi_turn
    tags: [e2e, happy-path, installment, future-debit]
    turns:
      # Introduction
      - user_input: "Yes, speaking"
        assertions:
          - type: contains_function_call
            value: "confirm_person"

      # Verification
      - user_input: "My ID is 8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "I live at 123 Main Street, Johannesburg"
        assertions:
          - type: contains_function_call
            value: "verify_field"

      # Negotiation
      - user_input: "I can't pay everything now, can I do installments?"
        assertions:
          - type: contains_function_call
            value: "offer_installment"
      - user_input: "Yes, I'll take the 2-payment plan"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

      # Payment
      - user_input: "Set up debit order for the 25th of each month"
        assertions:
          - type: contains_function_call
            value: "capture_future_debit"

      # Closing with referral
      - user_input: "My friend Sarah at 0825556666 needs tracking too"
        assertions:
          - type: contains_function_call
            value: "offer_referral"
      - user_input: "That's all, thanks"
        assertions:
          - type: contains_function_call
            value: "end_call"

  - name: "E2E-003: Complete flow - Portal payment preference"
    test_type: multi_turn
    tags: [e2e, happy-path, portal-payment]
    turns:
      # Introduction
      - user_input: "Yes, this is John"
        assertions:
          - type: contains_function_call
            value: "confirm_person"

      # Verification
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 January 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"

      # Negotiation
      - user_input: "I'll pay the full settlement today"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

      # Payment
      - user_input: "I prefer to pay online myself"
        assertions:
          - type: contains_function_call
            value: "capture_portal_payment"

      # Closing
      - user_input: "Perfect, goodbye"
        assertions:
          - type: contains_function_call
            value: "end_call"

  # ========================================================================
  # Wrong Person / Third Party Scenarios
  # ========================================================================
  - name: "E2E-004: Wrong person - End call immediately"
    test_type: multi_turn
    tags: [e2e, wrong-person, short-flow]
    turns:
      - user_input: "No, you have the wrong number. I don't know anyone by that name."
        assertions:
          - type: contains_function_call
            value: "handle_wrong_person"
          - type: llm-rubric
            value: "Agent should apologize and end the call without discussing any account details"
      - user_input: "Goodbye"
        assertions:
          - type: contains_function_call
            value: "end_call"

  - name: "E2E-005: Third party - Leave message"
    test_type: multi_turn
    tags: [e2e, third-party, message]
    turns:
      - user_input: "This is his wife speaking, John is at work"
        assertions:
          - type: contains_function_call
            value: "handle_third_party"
          - type: not-contains
            value: ["debt", "amount", "payment"]
      - user_input: "Yes, I'll tell him to call you back"
        assertions:
          - type: llm-rubric
            value: "Agent should provide callback number and thank third party"
      - user_input: "Okay, bye"
        assertions:
          - type: contains_function_call
            value: "end_call"

  - name: "E2E-006: Third party - Schedule callback"
    test_type: multi_turn
    tags: [e2e, third-party, callback]
    turns:
      - user_input: "This is his son, he's not home"
        assertions:
          - type: contains_function_call
            value: "handle_third_party"
      - user_input: "He'll be back at 5pm, can you call then?"
        assertions:
          - type: contains_function_call
            value: "schedule_callback"
      - user_input: "Thanks, goodbye"
        assertions:
          - type: contains_function_call
            value: "end_call"

  # ========================================================================
  # Callback Request Scenarios
  # ========================================================================
  - name: "E2E-007: Callback request at introduction"
    test_type: multi_turn
    tags: [e2e, callback, early-exit]
    turns:
      - user_input: "Yes, this is John, but I'm driving right now. Can you call back?"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "Tomorrow at 2pm would be good"
        assertions:
          - type: contains_function_call
            value: "schedule_callback"
      - user_input: "Thanks"
        assertions:
          - type: contains_function_call
            value: "end_call"

  - name: "E2E-008: Callback request during negotiation"
    test_type: multi_turn
    tags: [e2e, callback, mid-flow]
    turns:
      - user_input: "Yes, speaking"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "ID is 8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "Birth date is 12 Jan 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "I need to check my finances first, can you call me on Friday?"
        assertions:
          - type: contains_function_call
            value: "schedule_callback"

  - name: "E2E-009: Callback during payment - Missing bank details"
    test_type: multi_turn
    tags: [e2e, callback, payment-phase]
    turns:
      - user_input: "Yes, this is John"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 January 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "I'll take the settlement"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"
      - user_input: "I don't have my bank details with me now, call me back later"
        assertions:
          - type: contains_function_call
            value: "schedule_callback"

  # ========================================================================
  # Escalation Scenarios
  # ========================================================================
  - name: "E2E-010: Escalation - Dispute amount"
    test_type: multi_turn
    tags: [e2e, escalation, dispute]
    turns:
      - user_input: "Yes, this is John"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 Jan 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "That amount is completely wrong. I want to speak to a supervisor."
        assertions:
          - type: contains_function_call
            value: "escalate"
          - type: llm-rubric
            value: "Agent should acknowledge concern and offer supervisor escalation"

  - name: "E2E-011: Escalation - Legal concerns"
    test_type: multi_turn
    tags: [e2e, escalation, legal]
    turns:
      - user_input: "Yes, speaking"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "I have a lawyer handling this matter. You need to speak to them."
        assertions:
          - type: contains_function_call
            value: "escalate"

  - name: "E2E-012: Escalation - Harassment complaint"
    test_type: multi_turn
    tags: [e2e, escalation, complaint]
    turns:
      - user_input: "This is John, but I'm tired of these calls. This is harassment!"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "I want to speak to your manager right now"
        assertions:
          - type: contains_function_call
            value: "escalate"

  # ========================================================================
  # Cancellation Scenarios
  # ========================================================================
  - name: "E2E-013: Cancellation request - During negotiation"
    test_type: multi_turn
    tags: [e2e, cancellation]
    turns:
      - user_input: "Yes, this is John"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "Birth date 12 Jan 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "I don't want to pay this. Just cancel my subscription."
        assertions:
          - type: contains_function_call
            value: "handle_cancellation_request"
          - type: llm-rubric
            value: "Agent should log cancellation ticket and explain process"

  - name: "E2E-014: Cancellation then change of mind"
    test_type: multi_turn
    tags: [e2e, cancellation, reversal]
    turns:
      - user_input: "Yes, speaking"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 January 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "I want to cancel everything"
        assertions:
          - type: contains_function_call
            value: "handle_cancellation_request"
      - user_input: "Wait, if I pay will my service stay active?"
        assertions:
          - type: llm-rubric
            value: "Agent should explain that payment keeps service active"
      - user_input: "Okay, I'll pay the settlement then"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

  # ========================================================================
  # Difficult Customer Scenarios
  # ========================================================================
  - name: "E2E-015: Difficult customer - Financial hardship"
    test_type: multi_turn
    tags: [e2e, difficult, hardship]
    turns:
      - user_input: "Yes, this is John"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 Jan 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "I lost my job last month. I have no money at all."
        assertions:
          - type: llm-rubric
            value: "Agent should be empathetic and offer callback or escalation"
      - user_input: "Fine, call me back next month"
        assertions:
          - type: contains_function_call
            value: "schedule_callback"

  - name: "E2E-016: Difficult customer - Angry and hostile"
    test_type: multi_turn
    tags: [e2e, difficult, hostile]
    turns:
      - user_input: "What do you want now?! Stop calling me!"
        assertions:
          - type: llm-rubric
            value: "Agent should remain calm and professional, ask if speaking with John Smith"
      - user_input: "Yes it's me, what is it?!"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "I'm not giving you my ID, this could be a scam!"
        assertions:
          - type: llm-rubric
            value: "Agent should offer callback number for verification"
      - user_input: "Forget it, I want to speak to your supervisor"
        assertions:
          - type: contains_function_call
            value: "escalate"

  - name: "E2E-017: Difficult customer - Stalling tactics"
    test_type: multi_turn
    tags: [e2e, difficult, stalling]
    turns:
      - user_input: "Yes, speaking"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 January 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "I need to speak to my wife about this first"
        assertions:
          - type: llm-rubric
            value: "Agent should offer callback but emphasize urgency"
      - user_input: "She's busy for the next few weeks"
        assertions:
          - type: llm-rubric
            value: "Agent should explain consequences and offer specific callback time"
      - user_input: "Fine, call me Friday at 10am"
        assertions:
          - type: contains_function_call
            value: "schedule_callback"

  # ========================================================================
  # Verification Failure Scenarios
  # ========================================================================
  - name: "E2E-018: Verification fails - Incorrect details"
    test_type: multi_turn
    tags: [e2e, verification-failure]
    turns:
      - user_input: "Yes, this is John"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "My ID is 9999999999999"
        assertions:
          - type: llm-rubric
            value: "Agent should indicate mismatch and ask for another verification field"
      - user_input: "Birth date is 1 January 2000"
        assertions:
          - type: llm-rubric
            value: "Agent should indicate second mismatch and consider escalation"

  - name: "E2E-019: Verification incomplete - Customer refuses"
    test_type: multi_turn
    tags: [e2e, verification-refusal]
    turns:
      - user_input: "Yes, speaking"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "I'm not comfortable giving you my ID number"
        assertions:
          - type: llm-rubric
            value: "Agent should explain POPI compliance and offer alternative verification"
      - user_input: "No, I'm not giving you any personal information"
        assertions:
          - type: llm-rubric
            value: "Agent should offer callback number for customer to verify legitimacy"
      - user_input: "Fine, I'll call you back"
        assertions:
          - type: contains_function_call
            value: "end_call"

  # ========================================================================
  # Complex Multi-Issue Scenarios
  # ========================================================================
  - name: "E2E-020: Complex - Payment arrangement with multiple updates"
    test_type: multi_turn
    tags: [e2e, complex, complete-flow]
    turns:
      # Introduction & Verification
      - user_input: "Yes, this is John"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 Jan 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"

      # Negotiation
      - user_input: "I can pay half now and half next month"
        assertions:
          - type: contains_function_call
            value: "offer_installment"
      - user_input: "Yes, I'll do the installment plan"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

      # Payment
      - user_input: "Debit my FNB account on the 1st"
        assertions:
          - type: contains_function_call
            value: "capture_future_debit"

      # Closing with updates
      - user_input: "Also, my new phone number is 0829999888"
        assertions:
          - type: contains_function_call
            value: "update_contact_details"
      - user_input: "And my friend Mike at 0825557777 wants tracking"
        assertions:
          - type: contains_function_call
            value: "offer_referral"
      - user_input: "That's everything, thanks"
        assertions:
          - type: contains_function_call
            value: "end_call"

  - name: "E2E-021: Complex - Negotiation with dispute then resolution"
    test_type: multi_turn
    tags: [e2e, complex, dispute-resolution]
    turns:
      - user_input: "Yes, speaking"
        assertions:
          - type: contains_function_call
            value: "confirm_person"
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 January 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "This amount is way too high, I don't owe that much"
        assertions:
          - type: llm-rubric
            value: "Agent should offer to review or escalate for account verification"
      - user_input: "Okay, let me think about it. What's the settlement amount again?"
        assertions:
          - type: contains_function_call
            value: "offer_settlement"
      - user_input: "Alright, I'll pay that today"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"
      - user_input: "Use my Standard Bank account"
        assertions:
          - type: contains_function_call
            value: "capture_immediate_debit"
      - user_input: "Done, thanks"
        assertions:
          - type: contains_function_call
            value: "end_call"

  # ========================================================================
  # Script Type Specific E2E Flows
  # ========================================================================

  - name: "E2E-022: Short paid acknowledgment flow"
    test_type: multi_turn
    tags: [e2e, short_paid, complete-flow]
    test_data:
      script_type: "short_paid"
      partial_payment_received: 1000.00
      agreed_amount: 1500.00
      outstanding_amount: 500.00
    turns:
      # Introduction
      - user_input: "Yes, this is John"
        assertions:
          - type: contains_function_call
            value: "confirm_person"

      # Verification
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 January 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"

      # Negotiation - Short paid acknowledgment
      - user_input: "I already paid you R1000"
        assertions:
          - type: llm-rubric
            value: "Agent should acknowledge R1000 payment and explain R500 shortfall remains"
      - user_input: "Okay, I'll pay the R500 shortfall"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

      # Payment
      - user_input: "Debit my account immediately"
        assertions:
          - type: contains_function_call
            value: "capture_immediate_debit"

      # Closing
      - user_input: "That's all, thanks"
        assertions:
          - type: contains_function_call
            value: "end_call"

  - name: "E2E-023: Pro rata new customer flow"
    test_type: multi_turn
    tags: [e2e, pro_rata, complete-flow]
    test_data:
      script_type: "pro_rata_new"
      outstanding_amount: 350.00
      account_status: "active"
    turns:
      # Introduction
      - user_input: "Yes, speaking"
        assertions:
          - type: contains_function_call
            value: "confirm_person"

      # Verification
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 Jan 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"

      # Negotiation - Pro rata explanation
      - user_input: "What is this R350 for?"
        assertions:
          - type: llm-rubric
            value: "Agent should explain pro-rata payment for partial month from installation and that services activate after payment"
      - user_input: "Okay, I'll pay it"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

      # Payment
      - user_input: "Set up the debit for the 25th"
        assertions:
          - type: contains_function_call
            value: "setup_debicheck"
          - type: llm-rubric
            value: "Agent should emphasize having sufficient funds on agreed date"

      # Closing
      - user_input: "Thanks, goodbye"
        assertions:
          - type: contains_function_call
            value: "end_call"

  - name: "E2E-024: Recently suspended with two-tier negotiation"
    test_type: multi_turn
    tags: [e2e, recently_suspended, two_tier, complete-flow]
    test_data:
      script_type: "recently_suspended_120"
      outstanding_amount: 3000.00
      account_status: "active"
    turns:
      # Introduction
      - user_input: "Yes, this is John"
        assertions:
          - type: contains_function_call
            value: "confirm_person"

      # Verification
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 January 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"

      # Negotiation - Tier 1 (50%)
      - user_input: "What can you offer me?"
        assertions:
          - type: contains_function_call
            value: "offer_settlement"
          - type: llm-rubric
            value: "Agent should offer 50% discount (R1500) for once-off settlement"

      # Tier 2 (40%) after hesitation
      - user_input: "That's too much at once, can I pay less per month?"
        assertions:
          - type: llm-rubric
            value: "Agent should offer 40% discount (R1800) in 2 installments"
          - type: contains_function_call
            value: "offer_installment"

      - user_input: "Yes, I'll take the 2-payment plan"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

      # Payment
      - user_input: "Debit on the 1st of each month"
        assertions:
          - type: contains_function_call
            value: "capture_future_debit"

      # Closing
      - user_input: "Perfect, thanks"
        assertions:
          - type: contains_function_call
            value: "end_call"

  - name: "E2E-025: Cancelled account with paid-up letter"
    test_type: multi_turn
    tags: [e2e, cancelled_account, complete-flow]
    test_data:
      account_status: "cancelled"
      outstanding_amount: 1200.00
    turns:
      # Introduction
      - user_input: "Yes, speaking"
        assertions:
          - type: contains_function_call
            value: "confirm_person"

      # Verification
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 Jan 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"

      # Negotiation - Cancelled account benefits
      - user_input: "What happens if I pay this?"
        assertions:
          - type: llm-rubric
            value: "Agent should mention account closes in good standing and paid-up letter provided"
      - user_input: "Okay, I'll settle it"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

      # Payment
      - user_input: "Send me the payment link"
        assertions:
          - type: contains_function_call
            value: "send_portal_link"
          - type: llm-rubric
            value: "Agent should mention card, Ozow, CapitecPay, and Pay@ options"

      # Closing
      - user_input: "Got it, I'll pay now. Goodbye"
        assertions:
          - type: contains_function_call
            value: "end_call"

  - name: "E2E-026: Active account with bank validation warning"
    test_type: multi_turn
    tags: [e2e, bank_validation, reversal_history, complete-flow]
    test_data:
      account_status: "active"
      has_reversal_history: true
    turns:
      # Introduction
      - user_input: "Yes, this is John"
        assertions:
          - type: contains_function_call
            value: "confirm_person"

      # Verification
      - user_input: "8501125678901"
        assertions:
          - type: contains_function_call
            value: "verify_field"
      - user_input: "12 Jan 1985"
        assertions:
          - type: contains_function_call
            value: "verify_field"

      # Negotiation
      - user_input: "I'll pay the settlement"
        assertions:
          - type: contains_function_call
            value: "accept_arrangement"

      # Payment - Reversal warning
      - user_input: "Debit my account on the 25th"
        assertions:
          - type: contains_function_call
            value: "validate_bank_details"
      - user_input: "Yes, I'll make sure the money is there"
        assertions:
          - type: llm-rubric
            value: "Agent should warn about previous reversals and strongly recommend DebiCheck"
      - user_input: "Okay, use DebiCheck"
        assertions:
          - type: contains_function_call
            value: "setup_debicheck"
          - type: llm-rubric
            value: "Agent should mention R10 fee and SMS authentication"

      # Closing with referral
      - user_input: "My friend Sarah at 0825556666 wants Cartrack too"
        assertions:
          - type: contains_function_call
            value: "offer_referral"
          - type: llm-rubric
            value: "Agent should mention 2 months free subscription for successful referral"
      - user_input: "That's all, thanks"
        assertions:
          - type: contains_function_call
            value: "end_call"
